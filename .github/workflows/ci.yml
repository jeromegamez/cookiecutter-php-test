name: CI

on:
  pull_request:
    paths:
      - '.github/workflows/ci.yml'
      - '.roave-backward-compatibility-check.xml'
      - 'src/**'
      - 'tests/**'
      - 'composer.json'
      - '.phive/phars.xml'
      - '.php-cs-fixer.dist.php'
      - 'composer-dependency-analyser.php'
      - 'composer-require-checker.json'
      - 'infection.json5.dist'
      - 'phpstan.neon.dist'
      - 'phpunit.dist.xml'
      - 'rector.php'
      - 'tools/**'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/ci.yml'
      - '.roave-backward-compatibility-check.xml'
      - 'src/**'
      - 'tests/**'
      - 'composer.json'
      - '.phive/phars.xml'
      - '.php-cs-fixer.dist.php'
      - 'composer-dependency-analyser.php'
      - 'composer-require-checker.json'
      - 'infection.json5.dist'
      - 'phpstan.neon.dist'
      - 'phpunit.dist.xml'
      - 'rector.php'
      - 'tools/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  dependency-validation:
    name: Dependency Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, json, openssl, phar
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Validate composer.json
        run: composer validate --strict

      - name: Ensure dependencies can be installed
        run: composer install --no-interaction --no-progress --ansi --dry-run

  static-analysis:
    name: Static Analysis
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, ctype, dom, json, libxml, mbstring, phar, tokenizer, xml, xmlwriter
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi

      - name: Install PHAR tools with Phive
        run: composer tools:install

      - name: Install PHPStan dependencies
        run: composer tools:phpstan:install

      - name: Create tool links
        run: composer tools:link

      - name: Setup Problem Matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"

      - name: Static Analysis
        run: composer analyze

  unit-tests:
    name: Unit Tests (PHP ${{ matrix.php }}, ${{ matrix.dependencies }})
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PHP_INI_VALUES: memory_limit=-1, zend.assertions=1, error_reporting=-1, log_errors_max_len=0, display_errors=On

    strategy:
      fail-fast: false
      matrix:
        php:
          - "8.4"
          - "8.5"
        dependencies:
          - "lowest"
          - "highest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: none, ctype, curl, dom, json, libxml, mbstring, openssl, phar, tokenizer, xml, xmlwriter, pcntl
          ini-values: ${{ env.PHP_INI_VALUES }}
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: |
          if [ "${{ matrix.dependencies }}" = "lowest" ]; then
            composer update --prefer-lowest --prefer-stable --no-interaction --no-progress --ansi
          else
            composer update --no-interaction --no-progress --ansi
          fi

      - name: Install PHAR tools with Phive
        run: composer tools:install

      - name: Setup Problem Matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Run PHPUnit
        run: composer test:unit -- --error-format=github

  lint:
    name: Lint
    needs:
      - dependency-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, iconv, json, phar, tokenizer
          coverage: none
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi

      - name: Install PHAR tools with Phive
        run: composer tools:install

      - name: Install Rector dependencies
        run: composer tools:rector:install

      - name: Run linter suite
        run: composer lint

  code-coverage:
    name: Code Coverage
    needs:
      - unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PHP_INI_VALUES: memory_limit=-1, zend.assertions=1, error_reporting=-1, log_errors_max_len=0, display_errors=On

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: none, ctype, curl, dom, json, libxml, mbstring, openssl, phar, tokenizer, xml, xmlwriter, pcntl
          ini-values: ${{ env.PHP_INI_VALUES }}
          coverage: xdebug
          tools: composer

      - name: Get Composer cache directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer cache directory
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies with Composer
        run: composer update --no-interaction --no-progress --ansi

      - name: Install PHAR tools with Phive
        run: composer tools:install

      - name: Cache PHPUnit static analysis cache
        uses: actions/cache@v5
        with:
          path: .phpunit.cache/code-coverage
          key: ${{ runner.os }}-phpunit-code-coverage-${{ github.ref }}-
          restore-keys: |
            ${{ runner.os }}-phpunit-code-coverage-${{ github.ref }}-

      - name: Warm PHPUnit static analysis cache
        run: tools/phpunit --warm-coverage-cache

      - name: Collect code coverage with PHPUnit
        run: tools/phpunit --log-junit build/test-results.xml --coverage-clover build/code-coverage.xml

      # - name: Upload test results to Codecov.io
      #   if: ${{ !cancelled() }}
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     report_type: test_results
      #     disable_search: true
      #     files: ./build/test-results.xml

      # - name: Upload code coverage data to Codecov.io
      #   if: ${{ !cancelled() }}
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     report_type: coverage
      #     disable_search: true
      #     files: ./build/code-coverage.xml

  bc-check:
    name: Backward Compatibility Check
    needs:
      - unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Roave BC Check
        uses: docker://nyholm/roave-bc-check-ga
